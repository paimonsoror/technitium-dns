---
# Service for DNS Web Console
apiVersion: v1
kind: Service
metadata:
  name: {{ include "technitium-dns-server.fullname" . }}-web
  labels:
    {{- include "technitium-dns-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: web
  {{- with .Values.service.web.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.service.web.type }}
  ports:
  - port: {{ .Values.service.web.port }}
    targetPort: web-http
    protocol: TCP
    name: http
  selector:
    {{- include "technitium-dns-server.selectorLabels" . | nindent 4 }}
---
# Service for DNS (UDP port 53)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "technitium-dns-server.fullname" . }}-dns-udp
  labels:
    {{- include "technitium-dns-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: dns
  {{- with .Values.service.dns.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.service.dns.type }}
  {{- if .Values.service.dns.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.dns.loadBalancerIP }}
  {{- end }}
  {{- if .Values.service.dns.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
    {{- toYaml .Values.service.dns.loadBalancerSourceRanges | nindent 4 }}
  {{- end }}
  ports:
  - port: 53
    targetPort: dns-udp
    protocol: UDP
    name: dns-udp
  selector:
    {{- include "technitium-dns-server.selectorLabels" . | nindent 4 }}
---
# Service for DNS (TCP port 53)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "technitium-dns-server.fullname" . }}-dns-tcp
  labels:
    {{- include "technitium-dns-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: dns
  {{- with .Values.service.dns.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.service.dns.type }}
  {{- if .Values.service.dns.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.dns.loadBalancerIP }}
  {{- end }}
  {{- if .Values.service.dns.loadBalancerSourceRanges }}
  loadBalancerSourceRanges:
    {{- toYaml .Values.service.dns.loadBalancerSourceRanges | nindent 4 }}
  {{- end }}
  ports:
  - port: 53
    targetPort: dns-tcp
    protocol: TCP
    name: dns-tcp
  selector:
    {{- include "technitium-dns-server.selectorLabels" . | nindent 4 }}
{{- if .Values.service.dnsTls.enabled }}
---
# Service for DNS-over-TLS (port 853)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "technitium-dns-server.fullname" . }}-dns-tls
  labels:
    {{- include "technitium-dns-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: dns-tls
  {{- with .Values.service.dnsTls.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.service.dnsTls.type }}
  ports:
  - port: {{ .Values.service.dnsTls.port }}
    targetPort: dns-tls-udp
    protocol: UDP
    name: dns-tls-udp
  - port: {{ .Values.service.dnsTls.port }}
    targetPort: dns-tls-tcp
    protocol: TCP
    name: dns-tls-tcp
  selector:
    {{- include "technitium-dns-server.selectorLabels" . | nindent 4 }}
{{- end }}
{{- if .Values.service.dnsHttps.enabled }}
---
# Service for DNS-over-HTTPS (port 443)
apiVersion: v1
kind: Service
metadata:
  name: {{ include "technitium-dns-server.fullname" . }}-dns-https
  labels:
    {{- include "technitium-dns-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: dns-https
  {{- with .Values.service.dnsHttps.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.service.dnsHttps.type }}
  ports:
  - port: {{ .Values.service.dnsHttps.port }}
    targetPort: dns-https-udp
    protocol: UDP
    name: dns-https-udp
  - port: {{ .Values.service.dnsHttps.port }}
    targetPort: dns-https-tcp
    protocol: TCP
    name: dns-https-tcp
  selector:
    {{- include "technitium-dns-server.selectorLabels" . | nindent 4 }}
{{- end }}
